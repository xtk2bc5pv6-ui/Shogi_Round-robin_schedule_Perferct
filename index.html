<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°†æ£‹ é€šç®—å‹æ•—è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #121212; --neon-green: #39ff14; --danger-color: #ff3333; }
        body { background-color: var(--bg-color); color: var(--neon-green); font-family: "M PLUS Rounded 1c", sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; padding-bottom: 150px; }
        
        /* è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #status-board { background: #222; border: 2px solid #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: bold; line-height: 1.6; }
        .status-ok { color: var(--neon-green); border-color: var(--neon-green); }
        .status-warn { color: #ffff00; border-color: #ffff00; }
        .status-error { color: var(--danger-color); border-color: var(--danger-color); background: rgba(255,0,0,0.1); }
        .error-detail { font-size: 0.9rem; color: #ff9999; margin-left: 15px; font-weight: normal; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid var(--neon-green); margin-bottom: 20px; }
        h1 { text-align: center; text-shadow: 0 0 10px var(--neon-green); }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€š */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; vertical-align: middle; }
        th { background: #000; color: #00ffff; }
        
        /* ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ã®å·¦ä¸Šã‚»ãƒ«è£…é£¾ */
        .matrix-corner { font-size: 0.8rem; line-height: 1.2; color: #ccc; background: #222; }
        .matrix-label-self { display: block; text-align: left; color: #39ff14; }
        .matrix-label-opp { display: block; text-align: right; color: #00ffff; }
        .diagonal-cell { background: #111; }
        
        /* ãƒãƒŠãƒ¼ */
        .streak-banner { background: rgba(0,0,0,0.6); border: 1px dashed #ff00ff; color: #ff00ff; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-weight: bold; display: none; }

        /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stats-card { background: #000; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .stats-header { text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; font-size: 1.2rem; }
        .charts-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .chart-wrapper { flex: 1; min-width: 140px; max-width: 220px; text-align: center; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .chart-title { font-size: 0.9rem; margin-bottom: 5px; color: #ccc; }
        .chart-score { font-size: 1rem; margin-top: 5px; font-weight: bold; }

        /* Loading */
        #loading { position: fixed; inset:0; background:#000; display:flex; justify-content:center; align-items:center; z-index:999; font-size:1.5rem;}
    </style>
</head>
<body>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="status-board">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­...</div>

    <h1>å°†æ£‹ é€šç®—å‹æ•—è¡¨</h1>
    <div id="streakBanner" class="streak-banner"></div>

    <div class="card">
        <h2>é †ä½è¡¨</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>é †ä½</th><th>æ°å</th><th>å‹ - è² </th><th>å‹ç‡</th><th>è©¦åˆæ•°</th></tr></thead>
                <tbody id="rankingBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>å¯¾æˆ¦ã‚¹ã‚³ã‚¢è¡¨</h2>
        <div style="overflow-x:auto;">
            <table id="matrixTable">
                <thead id="matrixHead"></thead>
                <tbody id="matrixBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>å€‹äººæˆç¸¾åˆ†æï¼ˆå¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ï¼‰</h2>
        <div id="statsList" class="stats-grid"></div>
    </div>

    <script>
        const EXCEL_FILE_NAME = './shogi_data.xlsx'; 
        let players = [], matches = [];
        let chartInstances = []; // â˜…ä¿®æ­£: å¤‰æ•°å®šç¾©ã‚’è¿½åŠ 

        // Chart.js ãƒ—ãƒ©ã‚°ã‚¤ãƒ³: ä¸­å¿ƒã«ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
        const centerTextPlugin = {
            id: 'centerText',
            beforeDraw: function(chart) {
                if (chart.config.type !== 'doughnut') return;
                var width = chart.width, height = chart.height, ctx = chart.ctx;
                ctx.restore();
                var text = chart.config.options.elements.center.text;
                if (!text) return;
                var fontSize = (height / 100).toFixed(2);
                ctx.font = "bold " + fontSize + "em 'M PLUS Rounded 1c'";
                ctx.textBaseline = "middle";
                ctx.fillStyle = "#ff3333"; // èµ¤ãƒã‚ªãƒ³
                ctx.shadowColor = "#ff0000";
                ctx.shadowBlur = 10;
                var textX = Math.round((width - ctx.measureText(text).width) / 2);
                var textY = height / 2;
                ctx.fillText(text, textX, textY);
                ctx.shadowBlur = 0;
                ctx.save();
            }
        };
        Chart.register(centerTextPlugin);

        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            const statusBoard = document.getElementById('status-board');
            const loading = document.getElementById('loading');

            try {
                statusBoard.innerHTML = "ğŸ“¡ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
                
                const response = await fetch(EXCEL_FILE_NAME + '?t=' + Date.now()); 
                if (!response.ok) throw new Error(`âŒ Excelãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);

                const arrayBuffer = await response.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                if (!wb.Sheets["å¯¾æˆ¦å±¥æ­´"] || !wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]) throw new Error("âŒ ã‚·ãƒ¼ãƒˆåã‚¨ãƒ©ãƒ¼");

                const jsonPlayers = XLSX.utils.sheet_to_json(wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]);
                const jsonMatches = XLSX.utils.sheet_to_json(wb.Sheets["å¯¾æˆ¦å±¥æ­´"]);

                const cleanName = (name) => {
                    if (!name) return "";
                    return String(name).replace(/[\sã€€]+/g, ""); 
                };

                players = jsonPlayers.map(row => ({ 
                    id: row["ID"], 
                    displayName: row["åå‰"], 
                    searchName: cleanName(row["åå‰"]) 
                }));

                matches = [];
                let rowCount = 0;
                let errorDetails = [];

                jsonMatches.forEach((row, index) => {
                    const wSearch = cleanName(row["å‹è€…"]);
                    const lSearch = cleanName(row["æ•—è€…"]);
                    const wObj = players.find(p => p.searchName === wSearch);
                    const lObj = players.find(p => p.searchName === lSearch);

                    if (wObj && lObj) {
                        matches.push({ 
                            winner: wObj.id, loser: lObj.id, 
                            dateStr: row["å¯¾æˆ¦æ—¥"] || row["æ—¥æ™‚"] || "-", 
                            _order: rowCount++ 
                        });
                    } else {
                        if (row["å‹è€…"] || row["æ•—è€…"]) {
                            let reason = "";
                            if (!wObj) reason += `å‹è€…ã€Œ${row["å‹è€…"]}ã€ä¸æ˜ `;
                            if (!lObj) reason += `æ•—è€…ã€Œ${row["æ•—è€…"]}ã€ä¸æ˜`;
                            errorDetails.push(`${index + 2}è¡Œç›®: ${reason}`);
                        }
                    }
                });

                if (matches.length > 0) {
                    let msg = `âœ… èª­ã¿è¾¼ã¿æˆåŠŸï¼ (å…¨${matches.length}è©¦åˆ)`;
                    if (errorDetails.length > 0) {
                        msg += `<br><span style="color:#ffff00">âš ï¸ ã‚¨ãƒ©ãƒ¼è¡Œã‚ã‚Š (${errorDetails.length}ä»¶)</span>`;
                        statusBoard.className = "status-warn";
                    } else {
                        statusBoard.className = "status-ok";
                    }
                    statusBoard.innerHTML = msg;
                } else {
                    throw new Error("âŒ ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™ã€‚");
                }
                
                render();

            } catch (err) {
                statusBoard.className = "status-error";
                statusBoard.innerHTML = `âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: <br>${err.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function render() {
            let stats = players.map(p => ({ 
                id: p.id, name: p.displayName, wins: 0, losses: 0, total: 0, vs: Array(players.length).fill(0), currentStreak: 0 
            }));

            matches.sort((a, b) => a._order - b._order);

            matches.forEach(m => {
                if(!stats[m.winner] || !stats[m.loser]) return;
                stats[m.winner].wins++; stats[m.winner].total++; stats[m.winner].vs[m.loser]++;
                stats[m.loser].losses++; stats[m.loser].total++; stats[m.loser].vs[m.winner]++;

                if (stats[m.winner].currentStreak < 0) stats[m.winner].currentStreak = 1;
                else stats[m.winner].currentStreak++;

                if (stats[m.loser].currentStreak > 0) stats[m.loser].currentStreak = -1;
                else stats[m.loser].currentStreak--;
            });

            updateBanner(stats);

            // é †ä½è¡¨
            const tbody = document.
