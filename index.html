<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOGI BATTLE LOG - NEON Ver.</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #050505; --card-bg: rgba(20, 20, 20, 0.8);
            --neon-green: #39ff14; --neon-blue: #00f3ff; --neon-pink: #ff00ff; --neon-red: #ff0055;
            --text-glow: 0 0 5px currentColor, 0 0 15px currentColor;
            --box-glow: 0 0 10px currentColor, 0 0 20px currentColor inset;
        }
        body {
            margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--neon-green);
            font-family: "Orbitron", "M PLUS Rounded 1c", sans-serif; min-height: 100vh; position: relative; overflow-x: hidden;
        }
        #particles-js { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: radial-gradient(circle, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%); }
        .container { max-width: 1000px; margin: 0 auto; position: relative; z-index: 1; }
        .neon-text-g { color: var(--neon-green); text-shadow: var(--text-glow); }
        .neon-text-b { color: var(--neon-blue); text-shadow: var(--text-glow); }
        .neon-text-p { color: var(--neon-pink); text-shadow: var(--text-glow); }
        .neon-text-r { color: var(--neon-red); text-shadow: var(--text-glow); }

        h1 { font-size: 3rem; text-align: center; margin: 30px 0 10px; font-weight: 900; letter-spacing: 3px; color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green), 0 0 40px var(--neon-green); animation: flicker 3s infinite alternate; }
        .subtitle { text-align: center; font-size: 1.2rem; letter-spacing: 5px; color: var(--neon-blue); text-shadow: var(--text-glow); margin-bottom: 40px; opacity: 0.8; }
        @keyframes flicker { 0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; } 20%, 24%, 55% { opacity: 0.5; } }

        .card { background: var(--card-bg); border: 2px solid var(--neon-blue); box-shadow: 0 0 15px var(--neon-blue), inset 0 0 15px rgba(0, 243, 255, 0.2); border-radius: 15px; padding: 25px; margin-bottom: 30px; backdrop-filter: blur(5px); }
        h2 { font-size: 1.5rem; border-bottom: 2px solid var(--neon-pink); display: inline-block; padding-bottom: 5px; margin-top: 0; color: var(--neon-pink); text-shadow: var(--text-glow); }

        #status-board { background: rgba(0,0,0,0.7); border: 2px solid var(--neon-green); box-shadow: var(--box-glow); color: var(--neon-green); padding: 15px; margin-bottom: 30px; border-radius: 8px; font-weight: bold; min-height: 50px; text-shadow: 0 0 5px var(--neon-green); }
        .status-warn { border-color: #ffff00 !important; color: #ffff00 !important; box-shadow: 0 0 10px #ffff00, inset 0 0 20px #ffff00 !important; }
        .status-error { border-color: var(--neon-red) !important; color: var(--neon-red) !important; box-shadow: 0 0 10px var(--neon-red), inset 0 0 20px var(--neon-red) !important; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; border: 1px solid var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }
        th { background: rgba(0, 243, 255, 0.1); color: var(--neon-blue); padding: 12px; border-bottom: 2px solid var(--neon-blue); text-shadow: var(--text-glow); }
        td { padding: 12px; border-bottom: 1px solid rgba(0, 243, 255, 0.3); text-align: center; vertical-align: middle; }
        tbody tr:hover { background: rgba(0, 243, 255, 0.1); box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.2); }
        .matrix-corner { background: rgba(0,0,0,0.5); font-size: 0.8rem; }
        .diagonal-cell { background: rgba(0,0,0,0.8); }

        .streak-banner { background: rgba(255, 0, 255, 0.2); border: 2px solid var(--neon-pink); box-shadow: 0 0 20px var(--neon-pink); color: var(--neon-pink); padding: 15px; text-align: center; border-radius: 10px; margin-bottom: 30px; font-weight: 900; font-size: 1.2rem; text-shadow: var(--text-glow); display: none; animation: pulse 1.5s infinite alternate; }
        @keyframes pulse { from { box-shadow: 0 0 10px var(--neon-pink); } to { box-shadow: 0 0 30px var(--neon-pink), 0 0 10px var(--neon-pink) inset; } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .stats-card { background: rgba(0,0,0,0.6); border: 1px solid var(--neon-green); box-shadow: 0 0 10px var(--neon-green); padding: 15px; border-radius: 12px; }
        .stats-header { text-align: center; font-size: 1.3rem; color: var(--neon-green); text-shadow: var(--text-glow); margin-bottom: 15px; font-weight: bold; }
        .chart-wrapper { background: rgba(0,0,0,0.4); border: 1px solid rgba(57, 255, 20, 0.3); padding: 10px; border-radius: 8px; }
        .chart-title { font-size: 0.9rem; margin-bottom: 5px; color: rgba(255,255,255,0.7); }
        .chart-score { margin-top: 5px; font-weight: bold; }

        #loading { position: fixed; inset:0; background:#000; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; transition: opacity 0.5s; }
        .loading-text { font-size: 2rem; font-weight: 900; color: var(--neon-green); text-shadow: 0 0 20px var(--neon-green); animation: flicker 1s infinite; }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div id="loading"><div class="loading-text">SYSTEM BOOTING...</div><p style="font-size:0.8rem; color:var(--neon-blue); margin-top:10px;">CONNECTING TO DATA STREAM</p></div>
    
    <div class="container">
        <h1 class="neon-text-g">Â∞ÜÊ£ã ÈÄöÁÆóÂãùÊïóË°®</h1>
        <div class="subtitle">CYBER BATTLE LOG</div>
        <div id="status-board">INITIALIZING...</div>
        <div id="streakBanner" class="streak-banner"></div>

        <div class="card">
            <h2 class="neon-text-p">È†Ü‰ΩçË°® (RANKING)</h2>
            <div style="overflow-x:auto;">
                <table><thead><tr><th>Rank</th><th>Name</th><th>Result</th><th>Win Rate</th><th>Total</th></tr></thead><tbody id="rankingBody"></tbody></table>
            </div>
        </div>

        <div class="card" style="border-color: var(--neon-green); box-shadow: 0 0 15px var(--neon-green);">
            <h2 class="neon-text-g">ÂØæÊà¶„Çπ„Ç≥„Ç¢Ë°® (MATRIX)</h2>
            <div style="overflow-x:auto;">
                <table id="matrixTable" style="border-color: var(--neon-green);"><thead id="matrixHead" style="background: rgba(57, 255, 20, 0.1);"></thead><tbody id="matrixBody"></tbody></table>
            </div>
        </div>

        <div class="card" style="border-color: var(--neon-red); box-shadow: 0 0 15px var(--neon-red);">
            <h2 class="neon-text-r">ÂÄã‰∫∫ÊàêÁ∏æÂàÜÊûê (ANALYSIS)</h2>
            <div id="statsList" class="stats-grid"></div>
        </div>
    </div>

    <script>
        // ËÉåÊôØ„Ç®„Éï„Çß„ÇØ„Éà
        particlesJS('particles-js', { "particles": { "number": { "value": 80, "density": { "enable": true, "value_area": 800 } }, "color": { "value": ["#39ff14", "#00f3ff", "#ff00ff"] }, "shape": { "type": "circle" }, "opacity": { "value": 0.5, "random": true }, "size": { "value": 3, "random": true }, "line_linked": { "enable": true, "distance": 150, "color": "#00f3ff", "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 2, "direction": "none", "random": false, "straight": false, "out_mode": "out", "bounce": false } }, "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" }, "resize": true }, "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 1 } } } }, "retina_detect": true });

        const EXCEL_FILE_NAME = './shogi_data.xlsx'; 
        let players = [], matches = [];
        let chartInstances = [];

        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Âº∑Âà∂Ëß£Èô§„Çø„Ç§„Éû„Éº
        setTimeout(() => {
            const loader = document.getElementById('loading');
            if(loader && loader.style.display !== 'none') {
                loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500);
                const status = document.getElementById('status-board');
                if(status.innerText === "INITIALIZING...") { status.className = "status-error"; status.innerHTML = "‚ö†Ô∏è CONNECTION TIMEOUT: „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´ÊôÇÈñì„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇExcel„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"; }
            }
        }, 3000);

        window.addEventListener('DOMContentLoaded', () => {
            // Chart.js „Éó„É©„Ç∞„Ç§„É≥ÁôªÈå≤Ôºà‰∏≠ÂøÉ„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫Ôºâ
            if (typeof Chart !== 'undefined') {
                Chart.register({
                    id: 'centerText',
                    beforeDraw: function(chart) {
                        if (chart.config.type !== 'doughnut') return;
                        const { width, height, ctx } = chart;
                        ctx.restore();
                        const text = chart.config.options.elements.center?.text;
                        if (!text) return;
                        
                        // „Éï„Ç©„É≥„ÉàË™øÊï¥
                        const fontSize = (height / 140).toFixed(2); 
                        ctx.font = `900 ${fontSize}em 'M PLUS Rounded 1c'`;
                        ctx.textBaseline = "middle";
                        // Âº∑Âäõ„Å™Ëµ§„Éç„Ç™„É≥
                        const neonRed = "#ff0055"; 
                        ctx.fillStyle = neonRed;
                        ctx.shadowColor = neonRed;
                        ctx.shadowBlur = 25;

                        const textX = Math.round((width - ctx.measureText(text).width) / 2);
                        const textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.shadowBlur = 0;
                        ctx.save();
                    }
                });
            }
            init();
        });

        // „Éç„Ç™„É≥„Çπ„Éà„É©„Ç§„Éó„Éë„Çø„Éº„É≥ÁîüÊàêÈñ¢Êï∞
        function createNeonPattern(ctx, color) {
            const patternCanvas = document.createElement('canvas');
            const size = 15;
            patternCanvas.width = size; patternCanvas.height = size;
            const pCtx = patternCanvas.getContext('2d');
            pCtx.fillStyle = 'rgba(0,0,0,0.3)'; pCtx.fillRect(0, 0, size, size);
            pCtx.strokeStyle = color; pCtx.lineWidth = 2; pCtx.lineCap = 'round';
            pCtx.shadowColor = color; pCtx.shadowBlur = 5; 
            pCtx.beginPath(); pCtx.moveTo(-5, size + 5); pCtx.lineTo(size + 5, -5); pCtx.stroke();
            return ctx.createPattern(patternCanvas, 'repeat');
        }

        async function init() {
            const statusBoard = document.getElementById('status-board');
            try {
                if (typeof XLSX === 'undefined' || typeof Chart === 'undefined') throw new Error("SYSTEM ERROR: Library not loaded.");
                statusBoard.innerHTML = "üì° ACCESSING DATABASE...";
                const response = await fetch(EXCEL_FILE_NAME + '?t=' + Date.now()); 
                if (!response.ok) throw new Error(`‚ùå FILE NOT FOUND: Excel„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`);
                const arrayBuffer = await response.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                if (!wb.Sheets["ÂØæÊà¶Â±•Ê≠¥"] || !wb.Sheets["ÂèÇÂä†ËÄÖ„É™„Çπ„Éà"]) throw new Error("‚ùå DATA CORRUPTED: „Ç∑„Éº„ÉàÂêç„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                
                const jsonPlayers = XLSX.utils.sheet_to_json(wb.Sheets["ÂèÇÂä†ËÄÖ„É™„Çπ„Éà"]);
                const jsonMatches = XLSX.utils.sheet_to_json(wb.Sheets["ÂØæÊà¶Â±•Ê≠¥"]);
                const cleanName = (name) => name ? String(name).replace(/[\s„ÄÄ]+/g, "") : "";

                players = jsonPlayers.map(row => ({ id: row["ID"], displayName: row["ÂêçÂâç"], searchName: cleanName(row["ÂêçÂâç"]) }));
                matches = []; let rowCount = 0; let errorDetails = [];
                jsonMatches.forEach((row, index) => {
                    const wObj = players.find(p => p.searchName === cleanName(row["ÂãùËÄÖ"]));
                    const lObj = players.find(p => p.searchName === cleanName(row["ÊïóËÄÖ"]));
                    if (wObj && lObj) {
                        matches.push({ winner: wObj.id, loser: lObj.id, dateStr: row["ÂØæÊà¶Êó•"] || row["Êó•ÊôÇ"] || "-", _order: rowCount++ });
                    } else if (row["ÂãùËÄÖ"] || row["ÊïóËÄÖ"]) {
                        errorDetails.push(`${index + 2}Ë°åÁõÆ: ÂêçÂâç‰∏ç‰∏ÄËá¥`);
                    }
                });

                if (matches.length > 0) {
                    let msg = `‚úÖ SYSTEM READY. Loaded ${matches.length} matches.`;
                    if (errorDetails.length > 0) { msg += `<br><span style="color:#ffff00">‚ö†Ô∏è WARNING: ${errorDetails.length} lines skipped.</span>`; statusBoard.className = "status-warn"; } else { statusBoard.className = "status-ok"; }
                    statusBoard.innerHTML = msg;
                } else { throw new Error("‚ùå NO DATA: „Éá„Éº„Çø„Åå0‰ª∂„Åß„Åô„ÄÇ"); }
                render();
            } catch (err) {
                statusBoard.className = "status-error"; statusBoard.innerHTML = `‚ö†Ô∏è CRITICAL ERROR: <br>${err.message}`;
            } finally {
                const loader = document.getElementById('loading'); if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }
            }
        }

        function render() {
            let stats = players.map(p => ({ id: p.id, name: p.displayName, wins: 0, losses: 0, total: 0, vs: Array(players.length).fill(0), currentStreak: 0 }));
            matches.sort((a, b) => a._order - b._order);
            matches.forEach(m => {
                stats[m.winner].wins++; stats[m.winner].total++; stats[m.loser].losses++; stats[m.loser].total++; 
                stats[m.winner].vs[m.loser]++; // Ê≠£„Åó„ÅÑË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
                stats[m.winner].currentStreak = stats[m.winner].currentStreak < 0 ? 1 : stats[m.winner].currentStreak + 1;
                stats[m.loser].currentStreak = stats[m.loser].currentStreak > 0 ? -1 : stats[m.loser].currentStreak - 1;
            });

            // „Éê„Éä„Éº
            const banner = document.getElementById('streakBanner');
            let topStreak = 0, topName = "";
            stats.forEach(s => { if(s.currentStreak >= 3 && s.currentStreak > topStreak) { topStreak = s.currentStreak; topName = s.name; } });
            if (topStreak > 0) { banner.style.display = "block"; banner.innerHTML = `üî• CAUTION: ${topName} IS ON A ${topStreak}-WIN STREAK! üî•`; } else { banner.style.display = "none"; }

            // È†Ü‰ΩçË°®
            const tbody = document.getElementById('rankingBody'); tbody.innerHTML = "";
            [...stats].sort((a, b) => b.wins - a.wins).forEach((s, i) => {
                const rate = s.total ? (s.wins / s.total * 100).toFixed(1) : 0;
                let streakText = "";
                if(s.currentStreak >= 3) streakText = ` <span class="neon-text-p">üî•${s.currentStreak}ÈÄ£Âãù</span>`;
                else if(s.currentStreak <= -3) streakText = ` <span class="neon-text-b">‚òî${Math.abs(s.currentStreak)}ÈÄ£Êïó</span>`;
                tbody.innerHTML += `<tr><td>${i + 1}</td><td style="font-weight:bold; font-size:1.1rem;">${s.name}${streakText}</td><td><span class="neon-text-p">${s.wins}</span> - <span class="neon-text-b">${s.losses}</span></td><td>${rate}%</td><td>${s.total}</td></tr>`;
            });

            // „Éû„Éà„É™„ÇØ„Çπ
            const mHead = document.getElementById('matrixHead'); const mBody = document.getElementById('matrixBody');
            let hHtml = '<tr><th class="matrix-corner" style="border-color:var(--neon-green);"><span class="matrix-label-opp" style="color:var(--neon-green);">Opponent‚Üí</span><span class="matrix-label-self" style="color:var(--neon-green);">‚ÜìYou</span></th>';
            players.forEach(p => hHtml += `<th style="border-color:var(--neon-green); color:var(--neon-green);">${p.displayName}</th>`);
            mHead.innerHTML = hHtml + '</tr>'; mBody.innerHTML = '';
            stats.forEach((rowP) => {
               const tr = document.createElement('tr');
               let rowHtml = `<th style="border-color:var(--neon-green); color:var(--neon-green);">${rowP.name}</th>`;
               players.forEach((colP) => {
                   if (rowP.id === colP.id) rowHtml += '<td class="diagonal-cell" style="border-color:var(--neon-green);"></td>';
                   else {
                       const wins = rowP.vs[colP.id]; const losses = stats[colP.id].vs[rowP.id];
                       const content = (wins > 0 || losses > 0) ? `<span class="neon-text-p">${wins}</span> - <span class="neon-text-b">${losses}</span>` : '-';
                       rowHtml += `<td style="border-color:var(--neon-green);">${content}</td>`;
                   }
               });
               mBody.appendChild(tr).innerHTML = rowHtml;
            });

            // „Ç∞„É©„ÉïÊèèÁîªÂá¶ÁêÜ
            const container = document.getElementById('statsList');
            chartInstances.forEach(c => c.destroy()); chartInstances = []; container.innerHTML = '';
            stats.forEach(p => {
                const card = document.createElement('div'); card.className = 'stats-card';
                card.style.borderColor = "var(--neon-red)"; card.style.boxShadow = "0 0 10px var(--neon-red)";
                let chartsHtml = `<div class="charts-container">`;
                players.filter(opp => opp.id !== p.id).forEach(opp => {
                    const canvasId = `chart-${p.id}-vs-${opp.id}`;
                    chartsHtml += `<div class="chart-wrapper" style="border-color:var(--neon-red);"><div class="chart-title">vs ${opp.displayName}</div><div style="height:140px;"><canvas id="${canvasId}"></canvas></div><div class="chart-score"><span class="neon-text-p">${p.vs[opp.id]}Âãù</span> - <span class="neon-text-b">${stats[opp.id].vs[p.id]}Êïó</span></div></div>`;
                });
                card.innerHTML = `<div class="stats-header neon-text-r">${p.name}</div>` + chartsHtml + `</div>`;
                container.appendChild(card);
                players.filter(opp => opp.id !== p.id).forEach(opp => {
                    const canvas = document.getElementById(`chart-${p.id}-vs-${opp.id}`);
                    const ctx = canvas.getContext('2d');
                    const win = p.vs[opp.id], loss = stats[opp.id].vs[p.id];
                    
                    // „Éç„Ç™„É≥„Çπ„Éà„É©„Ç§„Éó„Éë„Çø„Éº„É≥ÈÅ©Áî®
                    const winPattern = createNeonPattern(ctx, '#ff00ff'); // Neon Pink
                    const lossPattern = createNeonPattern(ctx, '#00f3ff'); // Neon Blue
                    const grayPattern = createNeonPattern(ctx, '#444');

                    let chartData = (win==0&&loss==0) ? [1] : [win, loss];
                    let chartColors = (win==0&&loss==0) ? [grayPattern] : [winPattern, lossPattern];
                    let centerText = (win==0&&loss==0) ? "-" : `ÂãùÁéáÔºö${Math.round(win/(win+loss)*100)}ÔºÖ`;

                    chartInstances.push(new Chart(ctx, {
                        type: 'doughnut',
                        data: { 
                            labels: ['Win', 'Loss'], 
                            datasets: [{ 
                                data: chartData, 
                                backgroundColor: chartColors, 
                                borderWidth: 2,
                                borderColor: '#222',
                                cutout: '60%' 
                            }] 
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend:false, tooltip:{enabled:(win>0||loss>0)} }, elements: { center: { text: centerText } } }
                    }));
                });
            });
        }
    </script>
</body>
</html>
