<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOGI BATTLE LOG - NEON Ver.</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #050505; --card-bg: rgba(20, 20, 20, 0.85);
            --neon-green: #39ff14; --neon-blue: #00f3ff; --neon-pink: #ff00ff; --neon-red: #ff0055;
            --text-glow: 0 0 5px currentColor;
        }
        body {
            margin: 0; padding: 15px; background-color: var(--bg-color); color: var(--neon-green);
            font-family: "Orbitron", "M PLUS Rounded 1c", sans-serif; min-height: 100vh; overflow-x: hidden;
        }
        #particles-js { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: radial-gradient(circle, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%); }
        .container { max-width: 900px; margin: 0 auto; position: relative; z-index: 1; }

        h1 {
            font-size: clamp(1.8rem, 5vw, 3rem); text-align: center; margin: 20px 0 5px; font-weight: 900; letter-spacing: 2px;
            color: var(--neon-green); white-space: nowrap;
            text-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green);
            animation: flicker 3s infinite alternate;
        }
        .subtitle { text-align: center; font-size: 0.9rem; letter-spacing: 3px; color: var(--neon-blue); text-shadow: var(--text-glow); margin-bottom: 30px; opacity: 0.8; }
        @keyframes flicker { 0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; } 20%, 24%, 55% { opacity: 0.5; } }

        .card { background: var(--card-bg); border: 1px solid var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue), inset 0 0 10px rgba(0, 243, 255, 0.1); border-radius: 12px; padding: 15px; margin-bottom: 25px; backdrop-filter: blur(5px); }
        h2 { font-size: 1.2rem; border-bottom: 2px solid var(--neon-pink); display: inline-block; padding-bottom: 5px; margin-top: 0; color: var(--neon-pink); text-shadow: var(--text-glow); }

        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; min-width: 100%; }
        th, td { 
            padding: 10px 5px; text-align: center; vertical-align: middle; 
            border-bottom: 1px solid rgba(0, 243, 255, 0.3); white-space: nowrap; font-size: 0.95rem;
        }
        th { background: rgba(0, 243, 255, 0.1); color: var(--neon-blue); border-bottom: 2px solid var(--neon-blue); }
        
        .player-name-cell { cursor: pointer; color: var(--neon-green); text-decoration: underline; text-underline-offset: 4px; font-weight: bold; transition: 0.2s; }
        .player-name-cell:hover { color: #fff; text-shadow: 0 0 10px #fff; }
        
        /* „É¢„Éº„ÉÄ„É´ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 2000; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: #111; border: 2px solid var(--neon-red); box-shadow: 0 0 30px var(--neon-red);
            width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto;
            border-radius: 15px; padding: 20px; position: relative; text-align: center;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2rem; color: #fff; cursor: pointer; background: none; border: none; font-family: sans-serif; }
        .modal-title { font-size: 1.5rem; color: var(--neon-red); text-shadow: 0 0 10px var(--neon-red); margin-bottom: 10px; font-weight: bold; }

        /* Áõ¥ËøëÊàêÁ∏æ„Ç®„É™„Ç¢ */
        .recent-stats-box {
            background: rgba(255, 255, 255, 0.05); border: 1px solid #555; border-radius: 8px;
            padding: 15px; margin-bottom: 20px; text-align: center;
        }
        .recent-summary { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .recent-history { font-size: 1.5rem; letter-spacing: 5px; line-height: 1.5; word-break: break-all; }
        
        /* ‚òÖ‰øÆÊ≠£‚òÖ Êé®Áßª„ÅÆ„É¢„Éé„ÇØ„É≠Ë®≠ÂÆö */
        .mark-win { color: #ffffff; /* ÁôΩ */ }
        .mark-loss { color: #666666; /* „Ç∞„É¨„Éº (Èªí„ÅÆ‰ª£„Çè„Çä) */ }

        .charts-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .chart-wrapper { width: 45%; min-width: 140px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .chart-title { font-size: 0.85rem; color: #ccc; margin-bottom: 5px; }
        .chart-score { font-size: 1rem; font-weight: bold; margin-top: 5px; }

        .streak-banner { background: rgba(255,0,255,0.15); border: 1px solid var(--neon-pink); padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 1rem; color: var(--neon-pink); display: none; }
        .neon-text-p { color: var(--neon-pink); } .neon-text-b { color: var(--neon-blue); }
        .matrix-corner { font-size: 0.75rem; background: #222; }
        .diagonal-cell { background: #222; }
        
        #loading { position: fixed; inset:0; background:#000; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; transition: opacity 0.5s; }
        .loading-text { font-size: 1.5rem; font-weight: 900; color: var(--neon-green); animation: flicker 1s infinite; }

        @media (max-width: 600px) {
            body { padding: 10px; }
            h1 { margin-top: 10px; }
            .card { padding: 10px; }
            th, td { font-size: 0.85rem; padding: 8px 4px; }
            .chart-wrapper { width: 100%; } 
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div id="loading"><div class="loading-text">SYSTEM BOOTING...</div><p style="font-size:0.7rem; color:var(--neon-blue);">LOADING DATA...</p></div>
    
    <div class="container">
        <h1>Â∞ÜÊ£ã ÈÄöÁÆóÂãùÊïóË°®</h1>
        <div class="subtitle">CYBER BATTLE LOG</div>
        
        <div id="streakBanner" class="streak-banner"></div>

        <div class="card">
            <h2 style="color:var(--neon-pink)">È†Ü‰ΩçË°® (Ranking)</h2>
            <p style="font-size:0.8rem; color:#888; margin-bottom:10px;">‚ÄªÂêçÂâç„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®Ë©≥Á¥∞„Éá„Éº„Çø„ÅåË¶ã„Çå„Åæ„Åô</p>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>È†Ü‰Ωç</th><th>Ê∞èÂêç</th><th>ÂãùÊïó</th><th>ÂãùÁéá</th><th>Êï∞</th></tr></thead>
                    <tbody id="rankingBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card" style="border-color: var(--neon-green); box-shadow: 0 0 10px var(--neon-green);">
            <h2 style="color:var(--neon-green)">Á∑èÂΩì„Åü„ÇäË°® (Matrix)</h2>
            <div class="table-wrap">
                <table id="matrixTable" style="border-color: var(--neon-green);">
                    <thead id="matrixHead" style="background: rgba(57, 255, 20, 0.1);"></thead>
                    <tbody id="matrixBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModalForce()">√ó</button>
            <div id="modalTitle" class="modal-title">PLAYER NAME</div>
            
            <div id="modalRecent" class="recent-stats-box"></div>

            <div id="modalCharts" class="charts-container"></div>
        </div>
    </div>

    <script>
        particlesJS('particles-js', { "particles": { "number": { "value": 50 }, "color": { "value": ["#39ff14", "#00f3ff", "#ff00ff"] }, "shape": { "type": "circle" }, "opacity": { "value": 0.5 }, "size": { "value": 3 }, "line_linked": { "enable": true, "distance": 150, "color": "#00f3ff", "opacity": 0.3, "width": 1 }, "move": { "speed": 2 } }, "interactivity": { "events": { "onhover": { "enable": false }, "onclick": { "enable": true, "mode": "push" } } } });

        const EXCEL_FILE_NAME = './shogi_data.xlsx'; 
        let players = [], matches = [];
        let modalChartInstances = [];

        setTimeout(() => {
            const loader = document.getElementById('loading');
            if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }
        }, 3000);

        window.addEventListener('DOMContentLoaded', () => {
            if (typeof Chart !== 'undefined') {
                Chart.register({
                    id: 'centerText',
                    beforeDraw: function(chart) {
                        if (chart.config.type !== 'doughnut') return;
                        const { width, height, ctx } = chart;
                        ctx.restore();
                        const text = chart.config.options.elements.center?.text;
                        if (!text) return;
                        const fontSize = (height / 120).toFixed(2);
                        ctx.font = `900 ${fontSize}em 'M PLUS Rounded 1c'`;
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "#ff00ff"; ctx.shadowColor = "#ff00ff"; ctx.shadowBlur = 20;
                        const textX = Math.round((width - ctx.measureText(text).width) / 2);
                        const textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.shadowBlur = 0; ctx.save();
                    }
                });
            }
            init();
        });

        async function init() {
            try {
                const response = await fetch(EXCEL_FILE_NAME + '?t=' + Date.now()); 
                if (!response.ok) throw new Error("File not found");
                const arrayBuffer = await response.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                
                const jsonPlayers = XLSX.utils.sheet_to_json(wb.Sheets["ÂèÇÂä†ËÄÖ„É™„Çπ„Éà"]);
                const jsonMatches = XLSX.utils.sheet_to_json(wb.Sheets["ÂØæÊà¶Â±•Ê≠¥"]);
                const cleanName = (name) => name ? String(name).replace(/[\s„ÄÄ]+/g, "") : "";

                players = jsonPlayers.map(row => ({ id: row["ID"], displayName: row["ÂêçÂâç"], searchName: cleanName(row["ÂêçÂâç"]) }));
                matches = []; let rowCount = 0;
                jsonMatches.forEach((row) => {
                    const wObj = players.find(p => p.searchName === cleanName(row["ÂãùËÄÖ"]));
                    const lObj = players.find(p => p.searchName === cleanName(row["ÊïóËÄÖ"]));
                    if (wObj && lObj) {
                        matches.push({ winner: wObj.id, loser: lObj.id, _order: rowCount++ });
                    }
                });
                render();
            } catch (err) { console.error(err); } 
            finally { 
                const loader = document.getElementById('loading');
                if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }
            }
        }

        let statsData = [];

        function render() {
            statsData = players.map(p => ({ id: p.id, name: p.displayName, wins: 0, losses: 0, total: 0, vs: Array(players.length).fill(0), currentStreak: 0 }));
            matches.sort((a, b) => a._order - b._order);

            matches.forEach(m => {
                statsData[m.winner].wins++; statsData[m.winner].total++; 
                statsData[m.loser].losses++; statsData[m.loser].total++; 
                statsData[m.winner].vs[m.loser]++; 
                
                statsData[m.winner].currentStreak = statsData[m.winner].currentStreak < 0 ? 1 : statsData[m.winner].currentStreak + 1;
                statsData[m.loser].currentStreak = statsData[m.loser].currentStreak > 0 ? -1 : statsData[m.loser].currentStreak - 1;
            });

            const banner = document.getElementById('streakBanner');
            let topStreak = 0, topName = "";
            statsData.forEach(s => { if(s.currentStreak >= 3 && s.currentStreak > topStreak) { topStreak = s.currentStreak; topName = s.name; } });
            if (topStreak > 0) { banner.style.display = "block"; banner.innerHTML = `üî• ${topName} „Åå ${topStreak}ÈÄ£Âãù‰∏≠ÔºÅ üî•`; } else { banner.style.display = "none"; }

            const tbody = document.getElementById('rankingBody'); tbody.innerHTML = "";
            [...statsData].sort((a, b) => {
                const rateA = a.total ? a.wins / a.total : 0;
                const rateB = b.total ? b.wins / b.total : 0;
                if (rateB !== rateA) return rateB - rateA;
                return b.wins - a.wins;
            }).forEach((s, i) => {
                const rate = s.total ? (s.wins / s.total * 100).toFixed(1) : 0;
                let streakText = "";
                if(s.currentStreak >= 3) streakText = ` <span class="neon-text-p">üî•${s.currentStreak}</span>`;
                else if(s.currentStreak <= -3) streakText = ` <span class="neon-text-b">‚òî${Math.abs(s.currentStreak)}</span>`;
                
                tbody.innerHTML += `
                    <tr onclick="openModal(${s.id})">
                        <td>${i + 1}</td>
                        <td class="player-name-cell">${s.name}${streakText}</td>
                        <td><span class="neon-text-p">${s.wins}</span>-<span class="neon-text-b">${s.losses}</span></td>
                        <td>${rate}%</td>
                        <td>${s.total}</td>
                    </tr>`;
            });

            const mHead = document.getElementById('matrixHead'); const mBody = document.getElementById('matrixBody');
            let hHtml = '<tr><th class="matrix-corner" style="border-color:var(--neon-green);"><span style="color:var(--neon-blue); display:block; text-align:right;">Áõ∏Êâã‚Üí</span><span style="color:var(--neon-green); display:block; text-align:left;">‚ÜìËá™ÂàÜ</span></th>';
            players.forEach(p => hHtml += `<th style="border-color:var(--neon-green); color:var(--neon-green);">${p.displayName}</th>`);
            mHead.innerHTML = hHtml + '</tr>'; mBody.innerHTML = '';
            statsData.forEach((rowP) => {
               const tr = document.createElement('tr');
               let rowHtml = `<th style="border-color:var(--neon-green); color:var(--neon-green); white-space:nowrap;">${rowP.name}</th>`;
               players.forEach((colP) => {
                   if (rowP.id === colP.id) rowHtml += '<td class="diagonal-cell" style="border-color:var(--neon-green);"></td>';
                   else {
                       const wins = rowP.vs[colP.id]; const losses = statsData[colP.id].vs[rowP.id];
                       const content = (wins > 0 || losses > 0) ? `<span class="neon-text-p">${wins}</span>-<span class="neon-text-b">${losses}</span>` : '-';
                       rowHtml += `<td style="border-color:var(--neon-green);">${content}</td>`;
                   }
               });
               mBody.appendChild(tr).innerHTML = rowHtml;
            });
        }

        function openModal(playerId) {
            const playerStats = statsData.find(p => p.id === playerId);
            if(!playerStats) return;

            document.getElementById('modalTitle').innerText = `${playerStats.name} „ÅÆÊà¶Á∏æ`;
            const container = document.getElementById('modalCharts');
            const recentContainer = document.getElementById('modalRecent');
            container.innerHTML = "";
            recentContainer.innerHTML = "";
            modalChartInstances.forEach(c => c.destroy());
            modalChartInstances = [];

            // ‚òÖÁõ¥ËøëÊàêÁ∏æ„ÅÆË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ‚òÖ
            // Ëá™ÂàÜ„ÅÆË©¶Âêà„Å†„Åë„ÇíÊäΩÂá∫„Åó„ÄÅOrder(ID)„ÅÆÈôçÈ†ÜÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ„Å´‰∏¶„ÅπÊõø„Åà
            const myMatches = matches
                .filter(m => m.winner === playerId || m.loser === playerId)
                .sort((a, b) => b._order - a._order)
                .slice(0, 10); // ÊúÄÊñ∞10‰ª∂

            if (myMatches.length > 0) {
                let wCount = 0; let lCount = 0;
                let historyHtml = "";

                // ÊúÄÊñ∞„ÅåÂ∑¶„Å´Êù•„Çã„Çà„ÅÜ„Å´Ë°®Á§∫„Åó„ÅüÊñπ„ÅåÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑ„Åå„ÄÅ
                // „ÄåÊé®Áßª„Äç„Å®„Åó„Å¶ÊôÇÁ≥ªÂàóÔºàÈÅéÂéª‚ÜíÊú™Êù•Ôºâ„ÅßË¶ã„Åü„ÅÑÂ†¥Âêà„ÅØreverse„Åô„Çã„ÄÇ
                // „Åì„Åì„Åß„ÅØ„ÄåÂ∑¶ÔºùÈÅéÂéª ‚Üí Âè≥ÔºùÊúÄÊñ∞„Äç„ÅÆÊôÇÁ≥ªÂàóÈ†Ü„ÅßË°®Á§∫„Åó„Åæ„Åô„ÄÇ
                const displayMatches = [...myMatches].reverse(); 

                displayMatches.forEach(m => {
                    if (m.winner === playerId) {
                        wCount++;
                        historyHtml += '<span class="mark-win">‚óã</span>';
                    } else {
                        lCount++;
                        historyHtml += '<span class="mark-loss">‚óè</span>';
                    }
                });

                recentContainer.innerHTML = `
                    <div class="recent-summary">Áõ¥Ëøë10Êà¶Ôºö${wCount}Âãù ${lCount}Êïó</div>
                    <div class="recent-history">${historyHtml}</div>
                    <div style="font-size:0.7rem; color:#666; margin-top:5px;">(Â∑¶:ÈÅéÂéª ‚Üí Âè≥:ÊúÄÊñ∞)</div>
                `;
            } else {
                recentContainer.innerHTML = `<div style="color:#666">ÂØæÊà¶„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
            }

            const opponents = players.filter(opp => opp.id !== playerId);
            opponents.forEach(opp => {
                const win = playerStats.vs[opp.id];
                const loss = statsData[opp.id].vs[playerId];
                const wrapper = document.createElement('div');
                wrapper.className = 'chart-wrapper';
                const canvasId = `modalChart-${opp.id}`;
                wrapper.innerHTML = `<div class="chart-title">vs ${opp.displayName}</div><div style="height:120px; position:relative;"><canvas id="${canvasId}"></canvas></div><div class="chart-score"><span class="neon-text-p">${win}Âãù</span> - <span class="neon-text-b">${loss}Êïó</span></div>`;
                container.appendChild(wrapper);

                const ctx = document.getElementById(canvasId).getContext('2d');
                const winColor = 'rgba(255, 0, 255, 0.8)';
                const lossColor = 'rgba(0, 243, 255, 0.8)';
                const grayColor = 'rgba(68, 68, 68, 0.5)';
                let chartData = (win==0&&loss==0) ? [1] : [win, loss];
                let bgColors = (win==0&&loss==0) ? [grayColor] : [winColor, lossColor];
                let borderColors = (win==0&&loss==0) ? ['#555'] : ['#ff00ff', '#00f3ff'];
                let centerText = (win==0&&loss==0) ? "-" : `${Math.round(win/(win+loss)*100)}ÔºÖ`;

                modalChartInstances.push(new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['Win', 'Loss'], datasets: [{ data: chartData, backgroundColor: bgColors, borderColor: borderColors, borderWidth: 2, hoverOffset: 5, cutout: '65%' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false, tooltip: { enabled: (win>0||loss>0) } }, elements: { center: { text: centerText } } }
                }));
            });
            document.getElementById('statsModal').style.display = 'flex';
        }

        function closeModal(e) { if (e.target.id === 'statsModal') { document.getElementById('statsModal').style.display = 'none'; } }
        function closeModalForce() { document.getElementById('statsModal').style.display = 'none'; }
    </script>
</body>
</html>
