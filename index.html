<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°†æ£‹ é€šç®—å‹æ•—è¡¨ (è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #121212; --neon-green: #39ff14; --danger-color: #ff3333; }
        body { background-color: var(--bg-color); color: var(--neon-green); font-family: "M PLUS Rounded 1c", sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; padding-bottom: 150px; }
        
        /* è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
        #status-board {
            background: #222; border: 2px solid #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: bold;
        }
        .status-ok { color: var(--neon-green); border-color: var(--neon-green); }
        .status-error { color: var(--danger-color); border-color: var(--danger-color); background: rgba(255,0,0,0.1); }

        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid var(--neon-green); margin-bottom: 20px; }
        h1 { text-align: center; text-shadow: 0 0 10px var(--neon-green); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        th { background: #000; color: #00ffff; }
        
        /* Loading */
        #loading { position: fixed; inset:0; background:#000; display:flex; justify-content:center; align-items:center; z-index:999; font-size:1.5rem;}
    </style>
</head>
<body>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="status-board">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­...</div>

    <h1>å°†æ£‹ é€šç®—å‹æ•—è¡¨</h1>

    <div class="card">
        <h2>é †ä½è¡¨</h2>
        <table>
            <thead><tr><th>é †ä½</th><th>æ°å</th><th>å‹ - è² </th><th>å‹ç‡</th><th>è©¦åˆæ•°</th></tr></thead>
            <tbody id="rankingBody"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>å¯¾æˆ¦å±¥æ­´ (æœ€æ–°5ä»¶)</h2>
        <div id="historyList"></div>
    </div>

    <script>
        const EXCEL_FILE_NAME = './shogi_data.xlsx'; 
        let players = [], matches = [];

        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            const statusBoard = document.getElementById('status-board');
            const loading = document.getElementById('loading');

            try {
                // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
                statusBoard.innerHTML = "ğŸ“¡ GitHubä¸Šã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦ã„ã¾ã™...";
                
                const response = await fetch(EXCEL_FILE_NAME + '?t=' + Date.now()); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Œå…¨ç„¡è¦–
                
                if (!response.ok) {
                    throw new Error(`âŒ Excelãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (Error ${response.status})<br>ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«åãŒã€Œshogi_data.xlsxã€ã‹ç¢ºèªã—ã¦ãã ã•ã„<br>ãƒ»GitHubã®index.htmlã¨åŒã˜å ´æ‰€ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ`);
                }

                // 2. ãƒ‡ãƒ¼ã‚¿ã®è§£æ
                const arrayBuffer = await response.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                // 3. ã‚·ãƒ¼ãƒˆåã®ç¢ºèª
                if (!wb.Sheets["å¯¾æˆ¦å±¥æ­´"]) throw new Error("âŒ ã‚·ãƒ¼ãƒˆåã€Œå¯¾æˆ¦å±¥æ­´ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>Excelã®ã‚·ãƒ¼ãƒˆåã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                if (!wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]) throw new Error("âŒ ã‚·ãƒ¼ãƒˆåã€Œå‚åŠ è€…ãƒªã‚¹ãƒˆã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

                const jsonPlayers = XLSX.utils.sheet_to_json(wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]);
                const jsonMatches = XLSX.utils.sheet_to_json(wb.Sheets["å¯¾æˆ¦å±¥æ­´"]);

                // 4. ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ç¢ºèª
                if (jsonPlayers.length === 0) throw new Error("âŒ ã€Œå‚åŠ è€…ãƒªã‚¹ãƒˆã€ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                
                // ãƒ‡ãƒ¼ã‚¿å¤‰æ›
                players = jsonPlayers.map(row => ({ id: row["ID"], name: row["åå‰"] }));
                matches = [];
                let rowCount = 0;
                jsonMatches.forEach(row => {
                    const wObj = players.find(p => p.name === row["å‹è€…"]);
                    const lObj = players.find(p => p.name === row["æ•—è€…"]);
                    if (wObj && lObj) {
                        let ts = row["å¯¾æˆ¦æ—¥"] ? new Date(row["å¯¾æˆ¦æ—¥"]).getTime() : Date.now();
                        matches.push({ winner: wObj.id, loser: lObj.id, timestamp: ts, _order: rowCount++ });
                    }
                });

                // æˆåŠŸï¼
                statusBoard.className = "status-ok";
                statusBoard.innerHTML = `âœ… èª­ã¿è¾¼ã¿æˆåŠŸï¼<br>ãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${players.length}å<br>ãƒ»å¯¾æˆ¦ãƒ‡ãƒ¼ã‚¿: ${matches.length}ä»¶<br>ãƒ»æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®åæ˜ å®Œäº†`;
                
                render();

            } catch (err) {
                // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚
                statusBoard.className = "status-error";
                statusBoard.innerHTML = `âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: <br>${err.message}`;
                console.error(err);
            } finally {
                loading.style.display = 'none';
            }
        }

        function render() {
            // é›†è¨ˆ
            let stats = players.map(p => ({ id: p.id, name: p.name, wins: 0, losses: 0, total: 0 }));
            matches.forEach(m => {
                stats[m.winner].wins++; stats[m.winner].total++;
                stats[m.loser].losses++; stats[m.loser].total++;
            });
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            stats.sort((a, b) => b.wins - a.wins);
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = "";
            stats.forEach((s, i) => {
                const rate = s.total ? (s.wins/s.total*100).toFixed(1) : 0;
                tbody.innerHTML += `<tr><td>${i+1}</td><td>${s.name}</td><td>${s.wins}-${s.losses}</td><td>${rate}%</td><td>${s.total}</td></tr>`;
            });
            // å±¥æ­´
            const hList = document.getElementById('historyList');
            hList.innerHTML = "";
            // Excelã®ä¸‹ã®è¡Œã»ã©æ–°ã—ã„ã¨ã¿ãªã™
            [...matches].reverse().slice(0, 5).forEach(m => {
                const w = players.find(p => p.id === m.winner).name;
                const l = players.find(p => p.id === m.loser).name;
                hList.innerHTML += `<div style="padding:5px; border-bottom:1px solid #333">â—‹ ${w} vs â— ${l}</div>`;
            });
        }
    </script>
</body>
</html>
