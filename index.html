<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°†æ£‹ é€šç®—å‹æ•—è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #121212; --neon-green: #39ff14; --danger-color: #ff3333; }
        body { background-color: var(--bg-color); color: var(--neon-green); font-family: "M PLUS Rounded 1c", sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; padding-bottom: 150px; }
        
        /* è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #status-board { background: #222; border: 2px solid #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: bold; line-height: 1.6; }
        .status-ok { color: var(--neon-green); border-color: var(--neon-green); }
        .status-warn { color: #ffff00; border-color: #ffff00; }
        .status-error { color: var(--danger-color); border-color: var(--danger-color); background: rgba(255,0,0,0.1); }
        .error-detail { font-size: 0.9rem; color: #ff9999; margin-left: 15px; font-weight: normal; }

        /* ã‚¹ã‚¿ã‚¤ãƒ« */
        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid var(--neon-green); margin-bottom: 20px; }
        h1 { text-align: center; text-shadow: 0 0 10px var(--neon-green); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        th { background: #000; color: #00ffff; }
        
        /* Loading */
        #loading { position: fixed; inset:0; background:#000; display:flex; justify-content:center; align-items:center; z-index:999; font-size:1.5rem;}
        
        /* ãƒãƒŠãƒ¼ */
        .streak-banner { background: rgba(0,0,0,0.6); border: 1px dashed #ff00ff; color: #ff00ff; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="status-board">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­...</div>

    <h1>å°†æ£‹ é€šç®—å‹æ•—è¡¨</h1>

    <div id="streakBanner" class="streak-banner"></div>

    <div class="card">
        <h2>é †ä½è¡¨</h2>
        <table>
            <thead><tr><th>é †ä½</th><th>æ°å</th><th>å‹ - è² </th><th>å‹ç‡</th><th>è©¦åˆæ•°</th></tr></thead>
            <tbody id="rankingBody"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>å¯¾æˆ¦å±¥æ­´ (æœ€æ–°10ä»¶)</h2>
        <div id="historyList"></div>
    </div>

    <script>
        const EXCEL_FILE_NAME = './shogi_data.xlsx'; 
        let players = [], matches = [];

        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            const statusBoard = document.getElementById('status-board');
            const loading = document.getElementById('loading');

            try {
                statusBoard.innerHTML = "ğŸ“¡ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
                
                const response = await fetch(EXCEL_FILE_NAME + '?t=' + Date.now()); 
                
                if (!response.ok) {
                    throw new Error(`âŒ Excelãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                if (!wb.Sheets["å¯¾æˆ¦å±¥æ­´"] || !wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]) {
                    throw new Error("âŒ ã‚·ãƒ¼ãƒˆåã‚¨ãƒ©ãƒ¼: ã‚·ãƒ¼ãƒˆåã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }

                const jsonPlayers = XLSX.utils.sheet_to_json(wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]);
                const jsonMatches = XLSX.utils.sheet_to_json(wb.Sheets["å¯¾æˆ¦å±¥æ­´"]);

                // â˜…æœ€å¼·ã®æ­£è¦åŒ–é–¢æ•°: ã‚ã‚‰ã‚†ã‚‹ç©ºç™½ï¼ˆå…¨è§’ãƒ»åŠè§’ãƒ»ã‚¿ãƒ–ãªã©ï¼‰ã‚’æŠ¹æ¶ˆã—ã¦æ¯”è¼ƒã™ã‚‹â˜…
                const cleanName = (name) => {
                    if (!name) return "";
                    // æ­£è¦è¡¨ç¾ \s ã¯ã‚ã‚‰ã‚†ã‚‹ç©ºç™½æ–‡å­—ã€ã€€ã¯å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã€‚ã“ã‚Œã‚‰ã‚’å…¨ã¦ç©ºæ–‡å­—ã«ç½®æ›
                    return String(name).replace(/[\sã€€]+/g, ""); 
                };

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­ã¿è¾¼ã¿
                players = jsonPlayers.map(row => ({ 
                    id: row["ID"], 
                    displayName: row["åå‰"], // è¡¨ç¤ºç”¨ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šã§ã‚‚OKï¼‰
                    searchName: cleanName(row["åå‰"]) // æ¤œç´¢ç”¨ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãªã—ï¼‰
                }));

                matches = [];
                let rowCount = 0;
                let errorDetails = [];

                jsonMatches.forEach((row, index) => {
                    // Excelã®å…¥åŠ›å€¤ã‚‚ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¦æ¤œç´¢
                    const wSearch = cleanName(row["å‹è€…"]);
                    const lSearch = cleanName(row["æ•—è€…"]);
                    
                    const wObj = players.find(p => p.
