<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°†æ£‹ é€šç®—å‹æ•—è¡¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #121212; --neon-green: #39ff14; --danger-color: #ff3333; }
        body { background-color: var(--bg-color); color: var(--neon-green); font-family: "M PLUS Rounded 1c", sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; padding-bottom: 150px; }
        
        #status-board { background: #222; border: 2px solid #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: bold; line-height: 1.6; min-height: 50px;}
        .status-ok { color: var(--neon-green); border-color: var(--neon-green); }
        .status-warn { color: #ffff00; border-color: #ffff00; }
        .status-error { color: var(--danger-color); border-color: var(--danger-color); background: rgba(255,0,0,0.1); }
        .error-detail { font-size: 0.9rem; color: #ff9999; margin-left: 15px; font-weight: normal; }

        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid var(--neon-green); margin-bottom: 20px; }
        h1 { text-align: center; text-shadow: 0 0 10px var(--neon-green); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; vertical-align: middle; }
        th { background: #000; color: #00ffff; }
        
        .matrix-corner { font-size: 0.8rem; line-height: 1.2; color: #ccc; background: #222; }
        .matrix-label-self { display: block; text-align: left; color: #39ff14; }
        .matrix-label-opp { display: block; text-align: right; color: #00ffff; }
        .diagonal-cell { background: #111; }
        
        .streak-banner { background: rgba(0,0,0,0.6); border: 1px dashed #ff00ff; color: #ff00ff; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-weight: bold; display: none; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stats-card { background: #000; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .stats-header { text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; font-size: 1.2rem; }
        .charts-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .chart-wrapper { flex: 1; min-width: 140px; max-width: 220px; text-align: center; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .chart-title { font-size: 0.9rem; margin-bottom: 5px; color: #ccc; }
        .chart-score { font-size: 1rem; margin-top: 5px; font-weight: bold; }

        /* Loading */
        #loading { position: fixed; inset:0; background:#000; display:flex; justify-content:center; align-items:center; z-index:9999; font-size:1.5rem; transition: opacity 0.5s;}
    </style>
</head>
<body>

    <div id="loading">
        <div>
            <p>DATA LOADING...</p>
            <p style="font-size:0.8rem; color:#888; margin-top:10px;">(3ç§’ä»¥ä¸Šæ­¢ã¾ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã§ã™)</p>
        </div>
    </div>
    
    <div id="status-board">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆæœŸåŒ–ä¸­...</div>

    <h1>å°†æ£‹ é€šç®—å‹æ•—è¡¨</h1>
    <div id="streakBanner" class="streak-banner"></div>

    <div class="card">
        <h2>é †ä½è¡¨</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>é †ä½</th><th>æ°å</th><th>å‹ - è² </th><th>å‹ç‡</th><th>è©¦åˆæ•°</th></tr></thead>
                <tbody id="rankingBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>å¯¾æˆ¦ã‚¹ã‚³ã‚¢è¡¨</h2>
        <div style="overflow-x:auto;">
            <table id="matrixTable">
                <thead id="matrixHead"></thead>
                <tbody id="matrixBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>å€‹äººæˆç¸¾åˆ†æï¼ˆå¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ï¼‰</h2>
        <div id="statsList" class="stats-grid"></div>
    </div>

    <script>
        const EXCEL_FILE_NAME = './shogi_data.xlsx'; 
        let players = [], matches = [];
        let chartInstances = [];

        // â˜…å®‰å…¨è£…ç½®: 3ç§’çµŒã£ãŸã‚‰å¼·åˆ¶çš„ã«Loadingã‚’æ¶ˆã™â˜…
        setTimeout(() => {
            const loader = document.getElementById('loading');
            if(loader && loader.style.display !== 'none') {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
                // ã‚‚ã—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ›´æ–°ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                const status = document.getElementById('status-board');
                if(status.innerText === "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆæœŸåŒ–ä¸­...") {
                    status.className = "status-error";
                    status.innerHTML = "âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚<br>ãƒ»Excelãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ<br>ãƒ»é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                }
            }
        }, 3000);

        window.addEventListener('DOMContentLoaded', () => {
            // Chart.jsãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ²ï¼ˆChartã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            if (typeof Chart !== 'undefined') {
                Chart.register({
                    id: 'centerText',
                    beforeDraw: function(chart) {
                        if (chart.config.type !== 'doughnut') return;
                        var width = chart.width, height = chart.height, ctx = chart.ctx;
                        ctx.restore();
                        var text = chart.config.options.elements.center?.text; // å®‰å…¨ã‚¢ã‚¯ã‚»ã‚¹
                        if (!text) return;
                        var fontSize = (height / 100).toFixed(2);
                        ctx.font = "bold " + fontSize + "em 'M PLUS Rounded 1c'";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = "#ff3333";
                        ctx.shadowColor = "#ff0000";
                        ctx.shadowBlur = 10;
                        var textX = Math.round((width - ctx.measureText(text).width) / 2);
                        var textY = height / 2;
                        ctx.fillText(text, textX, textY);
                        ctx.shadowBlur = 0;
                        ctx.save();
                    }
                });
            }
            init();
        });

        async function init() {
            const statusBoard = document.getElementById('status-board');
            const loading = document.getElementById('loading');

            try {
                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯
                if (typeof XLSX === 'undefined' || typeof Chart === 'undefined') {
                    throw new Error("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }

                statusBoard.innerHTML = "ğŸ“¡ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
                
                const response = await fetch(EXCEL_FILE_NAME + '?t=' + Date.now()); 
                if (!response.ok) throw new Error(`âŒ Excelãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);

                const arrayBuffer = await response.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                if (!wb.Sheets["å¯¾æˆ¦å±¥æ­´"] || !wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]) throw new Error("âŒ ã‚·ãƒ¼ãƒˆåã‚¨ãƒ©ãƒ¼");

                const jsonPlayers = XLSX.utils.sheet_to_json(wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]);
                const jsonMatches = XLSX.utils.sheet_to_json(wb.Sheets["å¯¾æˆ¦å±¥æ­´"]);

                const cleanName = (name) => {
                    if (!name) return "";
                    return String(name).replace(/[\sã€€]+/g, ""); 
                };

                players = jsonPlayers.map(row => ({ 
                    id: row["ID"], 
                    displayName: row["åå‰"], 
                    searchName: cleanName(row["åå‰"]) 
                }));

                matches = [];
                let rowCount = 0;
                let errorDetails = [];

                jsonMatches.forEach((row, index) => {
                    const wSearch = cleanName(row["å‹è€…"]);
                    const lSearch = cleanName(row["æ•—è€…"]);
                    const wObj = players.find(p => p.searchName === wSearch);
                    const lObj = players.find(p => p.searchName === lSearch);

                    if (wObj && lObj) {
                        matches.push({ 
                            winner: wObj.id, loser: lObj.id, 
                            dateStr: row["å¯¾æˆ¦æ—¥"] || row["æ—¥æ™‚"] || "-", 
                            _order: rowCount++ 
                        });
                    } else {
                        if (row["å‹è€…"] || row["æ•—è€…"]) {
                            let reason = "";
                            if (!wObj) reason += `å‹è€…ã€Œ${row["å‹è€…"]}ã€ä¸æ˜ `;
                            if (!lObj) reason += `æ•—è€…ã€Œ${row["æ•—è€…"]}ã€ä¸æ˜`;
                            errorDetails.push(`${index + 2}è¡Œç›®: ${reason}`);
                        }
                    }
                });

                if (matches.length > 0) {
                    let msg = `âœ… èª­ã¿è¾¼ã¿æˆåŠŸï¼ (å…¨${matches.length}è©¦åˆ)`;
                    if (errorDetails.length > 0) {
                        msg += `<br><span style="color:#ffff00">âš ï¸ ã‚¨ãƒ©ãƒ¼è¡Œã‚ã‚Š (${errorDetails.length}ä»¶)</span>`;
                        statusBoard.className = "status-warn";
                    } else {
                        statusBoard.className = "status-ok";
                    }
                    statusBoard.innerHTML = msg;
                } else {
                    throw new Error("âŒ ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™ã€‚");
                }
                
                render();

            } catch (err) {
                statusBoard.className = "status-error";
                statusBoard.innerHTML = `âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: <br>${err.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function render() {
            let stats = players.map(p => ({ 
                id: p.id, name: p.displayName, wins: 0, losses: 0, total: 0, vs: Array(players.length).fill(0), currentStreak: 0 
            }));

            matches.sort((a, b) => a._order - b._order);

            matches.forEach(m => {
                if(!stats[m.winner] || !stats[m.loser]) return;
                stats[m.winner].wins++; stats[m.winner].total++; stats[m.winner].vs[m.loser]++;
                stats[m.loser].losses++; stats[m.loser].total++; stats[m.loser].vs[m.winner]++;

                if (stats[m.winner].currentStreak < 0) stats[m.winner].currentStreak = 1;
                else stats[m.winner].currentStreak++;

                if (stats[m.loser].currentStreak > 0) stats[m.loser].currentStreak = -1;
                else stats[m.loser].currentStreak--;
            });

            updateBanner(stats);

            // é †ä½è¡¨
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = "";
            let rankStats = [...stats].sort((a, b) => b.wins - a.wins);
            rankStats.forEach((s, i) => {
                const rate = s.total ? (s.wins / s.total * 100).toFixed(1) : 0;
                let streakText = "";
                if(s.currentStreak >= 3) streakText = ` <span style="color:#ff00ff">ğŸ”¥${s.currentStreak}é€£å‹</span>`;
                else if(s.currentStreak <= -3) streakText = ` <span style="color:#00ffff">â˜”${Math.abs(s.currentStreak)}é€£æ•—</span>`;
                tbody.innerHTML += `<tr><td>${i + 1}</td><td style="font-weight:bold">${s.name}${streakText}</td><td><span style="color:#ff00ff">${s.wins}</span> - <span style="color:#00ffff">${s.losses}</span></td><td>${rate}%</td><td>${s.total}</td></tr>`;
            });

            // ãƒãƒˆãƒªã‚¯ã‚¹è¡¨
            const mHead = document.getElementById('matrixHead');
            const mBody = document.getElementById('matrixBody');
            
            let hHtml = '<tr><th class="matrix-corner"><span class="matrix-label-opp">ç›¸æ‰‹â†’</span><span class="matrix-label-self">â†“è‡ªåˆ†</span></th>';
            players.forEach(p => hHtml += `<th>${p.displayName}</th>`);
            hHtml += '</tr>';
            mHead.innerHTML = hHtml;

            mBody.innerHTML = '';
            stats.forEach((rowP, i) => {
               const tr = document.createElement('tr');
               let rowHtml = `<th>${rowP.name}</th>`;
               players.forEach((colP, j) => {
                   if (rowP.id === colP.id) {
                       rowHtml += '<td class="diagonal-cell"></td>';
                   } else {
                       const wins = rowP.vs[colP.id]; 
                       const losses = stats[colP.id].vs[rowP.id];
                       let content = '-';
                       if (wins > 0 || losses > 0) {
                           content = `<span style="color:#ff00ff">${wins}</span> - <span style="color:#00ffff">${losses}</span>`;
                       }
                       rowHtml += `<td>${content}</td>`;
                   }
               });
               tr.innerHTML = rowHtml;
               mBody.appendChild(tr);
            });

            renderCharts(stats);
        }

        function renderCharts(statsData) {
            const container = document.getElementById('statsList');
            chartInstances.forEach(c => c.destroy()); chartInstances = []; container.innerHTML = '';
            
            statsData.forEach(p => {
                const card = document.createElement('div'); card.className = 'stats-card';
                const opponents = players.filter(opp => opp.id !== p.id);
                let chartsHtml = `<div class="charts-container">`;
                opponents.forEach(opp => {
                    const canvasId = `chart-${p.id}-vs-${opp.id}`;
                    const win = p.vs[opp.id];
                    const loss = statsData[opp.id].vs[p.id];
                    chartsHtml += `<div class="chart-wrapper"><div class="chart-title">vs ${opp.displayName}</div><div style="height:140px;"><canvas id="${canvasId}"></canvas></div><div class="chart-score"><span class="score-win">${win}å‹</span> - <span class="score-loss">${loss}æ•—</span></div></div>`;
                });
                chartsHtml += `</div>`;
                card.innerHTML = `<div class="stats-header">${p.name}</div>` + chartsHtml;
                container.appendChild(card);

                opponents.forEach(opp => {
                    const canvasId = `chart-${p.id}-vs-${opp.id}`;
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    const win = p.vs[opp.id];
                    const loss = statsData[opp.id].vs[p.id];
                    
                    let chartData = [win, loss];
                    let chartColors = ['#ff00ff', '#00ffff'];
                    let centerText = "";

                    if (win === 0 && loss === 0) {
                        chartData = [1]; chartColors = ['#333'];
                        centerText = "-";
                    } else {
                        const rate = (win / (win + loss) * 100).toFixed(0);
                        centerText = rate + "%";
                    }

                    chartInstances.push(new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Win', 'Loss'],
                            datasets: [{
                                data: chartData,
                                backgroundColor: chartColors,
                                borderWidth: 0,
                                cutout: '65%'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: (win > 0 || loss > 0) }
                            },
                            elements: {
                                center: { text: centerText }
                            }
                        }
                    }));
                });
            });
        }

        function updateBanner(stats) {
            const banner = document.getElementById('streakBanner');
            let topStreak = 0, topName = "";
            stats.forEach(s => { if(s.currentStreak >= 3 && s.currentStreak > topStreak) { topStreak = s.currentStreak; topName = s.name; } });
            if (topStreak > 0) {
                banner.style.display = "block";
                banner.innerHTML = `ğŸ”¥ ç¾åœ¨ã€${topName} ã•ã‚“ãŒ ${topStreak}é€£å‹ä¸­ï¼ èª°ã‹æ­¢ã‚ã‚ï¼ ğŸ”¥`;
            } else { banner.style.display = "none"; }
        }
    </script>
</body>
</html>
