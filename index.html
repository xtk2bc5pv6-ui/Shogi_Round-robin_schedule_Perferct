<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°†æ£‹ é€šç®—å‹æ•—è¡¨ (æ—¥ä»˜ä¸è¦ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #121212; --neon-green: #39ff14; --danger-color: #ff3333; }
        body { background-color: var(--bg-color); color: var(--neon-green); font-family: "M PLUS Rounded 1c", sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; padding-bottom: 150px; }
        
        /* è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #status-board { background: #222; border: 2px solid #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: bold; }
        .status-ok { color: var(--neon-green); border-color: var(--neon-green); }
        .status-warn { color: #ffff00; border-color: #ffff00; }
        .status-error { color: var(--danger-color); border-color: var(--danger-color); background: rgba(255,0,0,0.1); }

        /* ã‚¹ã‚¿ã‚¤ãƒ« */
        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid var(--neon-green); margin-bottom: 20px; }
        h1 { text-align: center; text-shadow: 0 0 10px var(--neon-green); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        th { background: #000; color: #00ffff; }
        
        /* ãƒãƒŠãƒ¼ */
        .streak-banner { background: rgba(0,0,0,0.6); border: 1px dashed #ff00ff; color: #ff00ff; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-weight: bold; display: none; }

        /* Loading */
        #loading { position: fixed; inset:0; background:#000; display:flex; justify-content:center; align-items:center; z-index:999; font-size:1.5rem;}
    </style>
</head>
<body>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="status-board">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­...</div>

    <h1>å°†æ£‹ é€šç®—å‹æ•—è¡¨</h1>

    <div id="streakBanner" class="streak-banner"></div>

    <div class="card">
        <h2>é †ä½è¡¨</h2>
        <table>
            <thead><tr><th>é †ä½</th><th>æ°å</th><th>å‹ - è² </th><th>å‹ç‡</th><th>è©¦åˆæ•°</th></tr></thead>
            <tbody id="rankingBody"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>å¯¾æˆ¦å±¥æ­´ (æœ€æ–°10ä»¶)</h2>
        <div id="historyList"></div>
    </div>

    <script>
        const EXCEL_FILE_NAME = './shogi_data.xlsx'; 
        let players = [], matches = [];

        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            const statusBoard = document.getElementById('status-board');
            const loading = document.getElementById('loading');

            try {
                statusBoard.innerHTML = "ğŸ“¡ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ã‚’ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
                const response = await fetch(EXCEL_FILE_NAME + '?t=' + Date.now()); 
                
                if (!response.ok) {
                    throw new Error(`âŒ Excelãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚GitHubã«ã€Œshogi_data.xlsxã€ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                if (!wb.Sheets["å¯¾æˆ¦å±¥æ­´"] || !wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]) {
                    throw new Error("âŒ ã‚·ãƒ¼ãƒˆåã‚¨ãƒ©ãƒ¼: ã€Œå¯¾æˆ¦å±¥æ­´ã€ã¾ãŸã¯ã€Œå‚åŠ è€…ãƒªã‚¹ãƒˆã€ã¨ã„ã†åå‰ã®ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                }

                const jsonPlayers = XLSX.utils.sheet_to_json(wb.Sheets["å‚åŠ è€…ãƒªã‚¹ãƒˆ"]);
                const jsonMatches = XLSX.utils.sheet_to_json(wb.Sheets["å¯¾æˆ¦å±¥æ­´"]);

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­ã¿è¾¼ã¿ (ç©ºç™½å‰Šé™¤ãªã©ã®èª¿æ•´ä»˜ã)
                players = jsonPlayers.map(row => ({ 
                    id: row["ID"], 
                    name: String(row["åå‰"]).trim() 
                }));

                // â˜…ã“ã“ãŒä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: æ—¥ä»˜ãŒãªãã¦ã‚‚å‹è€…ãƒ»æ•—è€…ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€â˜…
                matches = [];
                let rowCount = 0;
                let skipCount = 0;

                jsonMatches.forEach((row, index) => {
                    // åå‰å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤ã—ã¦ãƒãƒƒãƒãƒ³ã‚°ã•ã›ã‚‹
                    const wName = row["å‹è€…"] ? String(row["å‹è€…"]).trim() : "";
                    const lName = row["æ•—è€…"] ? String(row["æ•—è€…"]).trim() : "";
                    
                    const wObj = players.find(p => p.name === wName);
                    const lObj = players.find(p => p.name === lName);

                    if (wObj && lObj) {
                        matches.push({ 
                            winner: wObj.id, 
                            loser: lObj.id, 
                            // æ—¥ä»˜ãŒãªã‘ã‚Œã°ç©ºæ–‡å­—ã‚’å…¥ã‚Œã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ã«ã—ãªã„ï¼‰
                            dateStr: row["å¯¾æˆ¦æ—¥"] || row["æ—¥æ™‚"] || "-", 
                            _order: rowCount++ // Excelã®è¡Œé †ã‚’è¨˜éŒ²
                        });
                    } else {
                        // åå‰ãŒä¸€è‡´ã—ãªã„ã€ã¾ãŸã¯ç©ºæ¬„ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                        if(wName || lName) {
                            console.warn(`Skipped row ${index + 2}: ${wName} vs ${lName} (Name mismatch)`);
                            skipCount++;
                        }
                    }
                });

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
                if (matches.length > 0) {
                    let msg = `âœ… èª­ã¿è¾¼ã¿æˆåŠŸï¼ (å…¨${matches.length}è©¦åˆ)<br>ãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${players.length}å`;
                    if (skipCount > 0) {
                        msg += `<br>âš ï¸ æ³¨æ„: åå‰ãŒä¸€è‡´ã—ãªã„ãŸã‚èª­ã¿è¾¼ã‚ãªã‹ã£ãŸè¡ŒãŒ ${skipCount}ä»¶ ã‚ã‚Šã¾ã™ã€‚Excelã®åå‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                        statusBoard.className = "status-warn";
                    } else {
                        statusBoard.className = "status-ok";
                    }
                    statusBoard.innerHTML = msg;
                } else {
                    throw new Error("âŒ ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã™ã€‚Excelã®ã€Œå‹è€…ã€ã€Œæ•—è€…ã€åˆ—ã«æ­£ã—ã„åå‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
                
                render();

            } catch (err) {
                statusBoard.className = "status-error";
                statusBoard.innerHTML = `âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: <br>${err.message}`;
                console.error(err);
            } finally {
                loading.style.display = 'none';
            }
        }

        function render() {
            // é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
            let stats = players.map(p => ({ 
                id: p.id, name: p.name, wins: 0, losses: 0, total: 0, currentStreak: 0 
            }));

            // Excelã®è¡Œé †(_order)é€šã‚Šã«ãƒ«ãƒ¼ãƒ—ã—ã¦é€£å‹è¨ˆç®—
            matches.sort((a, b) => a._order - b._order);

            matches.forEach(m => {
                // å‹æ•—ã‚«ã‚¦ãƒ³ãƒˆ
                stats[m.winner].wins++;
                stats[m.winner].total++;
                stats[m.loser].losses++;
                stats[m.loser].total++;

                // é€£å‹è¨ˆç®—
                // å‹è€…: è² ã‘è¶Šã—ä¸­ãªã‚‰1(é€£å‹é–‹å§‹)ã€ãã†ã§ãªã„ãªã‚‰+1
                if (stats[m.winner].currentStreak < 0) stats[m.winner].currentStreak = 1;
                else stats[m.winner].currentStreak++;

                // æ•—è€…: å‹ã¡è¶Šã—ä¸­ãªã‚‰-1(é€£æ•—é–‹å§‹)ã€ãã†ã§ãªã„ãªã‚‰-1
                if (stats[m.loser].currentStreak > 0) stats[m.loser].currentStreak = -1;
                else stats[m.loser].currentStreak--;
            });

            // ãƒãƒŠãƒ¼æ›´æ–°
            updateBanner(stats);

            // é †ä½è¡¨æ›´æ–°
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = "";
            // å‹ã¡æ•°é †ã«ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
            let rankStats = [...stats].sort((a, b) => b.wins - a.wins);
            
            rankStats.forEach((s, i) => {
                const rate = s.total ? (s.wins / s.total * 100).toFixed(1) : 0;
                let streakText = "";
                if(s.currentStreak >= 3) streakText = ` <span style="color:#ff00ff">ğŸ”¥${s.currentStreak}é€£å‹</span>`;
                else if(s.currentStreak <= -3) streakText = ` <span style="color:#00ffff">â˜”${Math.abs(s.currentStreak)}é€£æ•—</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td style="font-weight:bold">${s.name}${streakText}</td>
                        <td><span style="color:#ff00ff">${s.wins}</span> - <span style="color:#00ffff">${s.losses}</span></td>
                        <td>${rate}%</td>
                        <td>${s.total}</td>
                    </tr>
                `;
            });

            // å±¥æ­´æ›´æ–°ï¼ˆæ–°ã—ã„é †ï¼é…åˆ—ã®é€†é †ã§è¡¨ç¤ºï¼‰
            const hList = document.getElementById('historyList');
            hList.innerHTML = "";
            // æœ€æ–°10ä»¶ã‚’è¡¨ç¤º
            [...matches].reverse().slice(0, 10).forEach(m => {
                const w = players.find(p => p.id === m.winner).name;
                const l = players.find(p => p.id === m.loser).name;
                // æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºã€ãªã‘ã‚Œã°çœç•¥
                const dateDisplay = m.dateStr !== "-" ? `<span style="font-size:0.8rem; color:#888;">(${m.dateStr})</span> ` : "";
                
                hList.innerHTML += `
                    <div style="padding:8px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                        <span>${dateDisplay}<span style="color:#ff00ff">â—‹ ${w}</span></span>
                        <span><span style="color:#00ffff">â— ${l}</span></span>
                    </div>
                `;
            });
        }

        function updateBanner(stats) {
            const banner = document.getElementById('streakBanner');
            // 3é€£å‹ä»¥ä¸Šã®äººãŒã„ã‚Œã°è¡¨ç¤º
            let topStreak = 0;
            let topName = "";
            
            stats.forEach(s => {
                if(s.currentStreak >= 3 && s.currentStreak > topStreak) {
                    topStreak = s.currentStreak;
                    topName = s.name;
                }
            });

            if (topStreak > 0) {
                banner.style.display = "block";
                banner.innerHTML = `ğŸ”¥ ç¾åœ¨ã€${topName} ã•ã‚“ãŒ ${topStreak}é€£å‹ä¸­ï¼ èª°ã‹æ­¢ã‚ã‚ï¼ ğŸ”¥`;
            } else {
                banner.style.display = "none";
            }
        }
    </script>
</body>
</html>
